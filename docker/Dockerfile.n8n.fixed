# Dockerfile для n8n с правильной установкой Neo4j зависимостей
FROM n8nio/n8n:latest

USER root

# Установка зависимостей Neo4j глобально с правильными симлинками
RUN npm install -g neo4j-driver@5.28.2 @langchain/community@0.3.56

# Создание node_modules в корне для доступа всех плагинов
RUN mkdir -p /usr/local/lib/node_modules/n8n/node_modules && \
    ln -sf /usr/local/lib/node_modules/neo4j-driver /usr/local/lib/node_modules/n8n/node_modules/neo4j-driver && \
    ln -sf /usr/local/lib/node_modules/@langchain /usr/local/lib/node_modules/n8n/node_modules/@langchain

# Создание директории для custom nodes
RUN mkdir -p /home/node/.n8n/custom && chown -R node:node /home/node/.n8n/custom

# Создание глобальной доступности для всех нод
RUN echo 'export NODE_PATH=/usr/local/lib/node_modules:$NODE_PATH' >> /home/node/.bashrc

# Возврат к пользователю node
USER node

# Установка NODE_PATH для runtime
ENV NODE_PATH=/usr/local/lib/node_modules:/usr/local/lib/node_modules/n8n/node_modules